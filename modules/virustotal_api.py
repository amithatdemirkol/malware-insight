# modules/virustotal_api.py

import requests
import os

API_KEY = 'YOUR_VIRUSTOTAL_API_KEY'  # Add your own API key here
BASE_URL = 'https://www.virustotal.com/vtapi/v2/file/scan'
REPORT_URL = 'https://www.virustotal.com/vtapi/v2/file/report'

def scan_file(file_path):
    """
    Scans the file using the VirusTotal API.
    :param file_path: Path of the file to be scanned
    :return: Scan result or error message
    """
    try:
        files = {'file': (os.path.basename(file_path), open(file_path, 'rb'))}
        params = {'apikey': API_KEY}
        response = requests.post(BASE_URL, files=files, params=params)

        if response.status_code == 200:
            result = response.json()
            return result.get('scan_id'), None
        elif response.status_code == 403:
            return None, "Invalid VirusTotal API key or daily limit exceeded."
        else:
            return None, f"VirusTotal scan error: {response.status_code}"
    except Exception as e:
        return None, f"An error occurred during scanning: {e}"

def get_scan_report(scan_id):
    """
    Returns the VirusTotal scan result.
    :param scan_id: Scan operation ID
    :return: Scan report or error message
    """
    try:
        params = {'apikey': API_KEY, 'resource': scan_id}
        response = requests.get(REPORT_URL, params=params)

        if response.status_code == 200:
            report = response.json()
            return report, None
        elif response.status_code == 403:
            return None, "Invalid VirusTotal API key or daily limit exceeded."
        else:
            return None, f"VirusTotal report error: {response.status_code}"
    except Exception as e:
        return None, f"An error occurred while retrieving the report: {e}"
